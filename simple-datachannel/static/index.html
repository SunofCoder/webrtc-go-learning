<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>DataChannel Test</title></head>
<body>
<h2>üì° WebRTC DataChannel Test</h2>
<input id="msg" placeholder="Message">
<button id="sendBtn" disabled onclick="sendMsg()">Send</button>
<pre id="log"></pre>

<script>
    const pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]})
    const channel = pc.createDataChannel("chat")

    channel.onopen = ()=>{log("‚úÖ DataChannel opened");document.getElementById("sendBtn").disabled=false}
    channel.onmessage = e=>log(`üì© Server: ${e.data}`)

    pc.onicecandidate = event => {
        if(event.candidate){
            fetch("/candidate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(event.candidate)})
        }
    }

    async function start(){
        const offer = await pc.createOffer()
        await pc.setLocalDescription(offer)
        const res = await fetch("/offer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(offer)})
        const answer = await res.json()
        await pc.setRemoteDescription(answer)
    }

    function sendMsg(){
        if(channel.readyState!=="open"){log("‚ùå Channel not open yet");return}
        const t=document.getElementById("msg").value
        channel.send(t)
        log(`You: ${t}`)
    }

    function log(msg){document.getElementById("log").textContent+=msg+"\n"}

    start()
</script>
</body>
</html>
